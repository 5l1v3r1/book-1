
## Encrypting your data

There are three states of data. Data in transit, when it flows through the network. Data in use, when it is actively being
read and modified and data at rest, which refers to data that is stored in stable storage. In the previous chapter, we discussed
securing your data in transit using TLS 1.2 and strong encryption. In this chapter, we are going to focus on securing your data
at rest. 

Some data is intrinsically public in nature, a press release, for example. Some data is _very_ private, such as healthcare, 
financial, personally identifying, etc. A part of any security consideration is the notion of a defence in depth. Even if your
servers are protected (physically and virtually), you still need to consider the case that someone will be able to get their
hands on your data.

RavenDB supports strong encryption (`XChaCha20Poly1305` with 256 bits key) to do full and transparent data encryption of your
entire database. This feature ensures that nothing unencrypted is written to the disk and even in memory, outside of a running
transaction, everything is encrypted. 

In many industries, data encryption is a regulatory requirement (PCI and HIPPA comes to mind) and it is a fairly routine 
request even if the application in question doesn't _require_ it, but can benefit from the additional safeties it provies. 
The encryption of data at rest doesn't come to replace other security measures (such as limit access to your database, encrypting
the communication lines, protecting your access credentials, etc) but to complement them. 

The major advantage of having encryption at the database level is that you don't need to change anything in your applications 
and clients. RavenDB will take care of all encryption behind the scenes, with no external changes that you have to deal with. 
A user that has access to an encrypted database can simple access it, query documents, modify them, etc. RavenDB will take 
care of encrypting and decrypting data as needed. RavenDB also require all encrytped database access to use HTTPS, so this takes
care of the data in transit portion as well. 

> **What database encryption does _not_ protect you from?**
> 
> Encrypting the database means that if you open your database file, the data inside it will appear indistinguishable from random
> noise, unless you have the key. This means that if you lost a hard disk, you can be sure that the data on it will not be accessible.
> But that is just one threat vector.
>
> Encrypting the database will not protect you from lost credentials. If that user has permissions for the
> database in question, RavenDB will decrypt the information from the disk and hand it over to this authorized user.
> 
> Such encryption will also only place a few hurdles in the path of someone that is able to execute code on the database machine
> as the database user or as `root`, because they will be able to connect to RavenDB using the `rvn admin-channel` and rergister
> a certificate, then just access the data normally. 

RavenDB goes to great lengths to ensure that on disk, and even in memory, your data is encrypted. The data is only decrypted when
there is an active transaction, and even then, only the pieces that are touched by that transaction are decrypted. Once the 
transaction is completed, RavenDB will zero the memory to erase the sensitive data. 

Database encryption should be deployed as part of comprehensive security strategy, including control access to the machines, 
having a secure backup strategy, including security concerns with your high availability and offsite deployment, key management
and the appropriate audit / monitoring tools. This is a much wider topic than can be covered in this book, so I'll focus only
on the details of data encryption in RavenDB.

Before we get to the details, I want to mention that encryption has a cost. In terms of the database performance, it is usually
around 5% - 10%, depending on the exact load. In most cases, that is a perfectly fine price to pay for the additional security.
However, there are also additional cost in managing encrypted databases. Key management and backup, secure backups, being able 
to _get_ the encryption key when you need to restore the database, etc. 

All of these can add up to significant operational overhead, as much as RavenDB attempts to reduce it. I suggest ensuring  that
you need the benefits of database encryption before enabling this feature, rather than just saying "encryption is good" and 
pressing forward needlessly. 

We'll start by doing a walkthough of actually defining an encrypted database through the studio, to get you started, and then
we'll dive into what is actually going on behind the scenes and how RavenDB is actively protecting your data.

### Setting up an encrypted database

The first requirement for an encrypted database is that your cluster will run in a secured mode. There is no point is securing
the data on disk if anyone on the network can see the data going in and out. In the [previous chapter](#security) we went over 
the steps required for a such a setup, so I'll skip them here. 

A database in RavenDB can be marked as encrypted at creation time. You can see how this looks like on the studio in Figure 14.1.

![Creating an encrypted database](./Ch14/img01.png)

An encrypted database uses a 256 bits key to encrypt all the data stored in the database. Without that key, the data in the 
database is only so much random seeming noise. As you can imagine, that key is _important_. RavenDB also provides no way to 
get the encryption key of an existing database, you have to know that in advance. The properties of the key are also important.
The key is a 256 bits value, generated using a cryptographically strong random number generator. You _can_ provide you own key,
but in general, there is little reason to bother. 

What you should be doing is keep a copy of the encryption key somewhere, so you'll have access to this key (and thus, the 
database using it) later on, if needed. RavenDB make such a decision explicit, as you can see in Figure 14.2. 

![Encryption configuration includes just the key, and require that you'll store a copy of it](./Ch14/img02.png)

You have to confirm that you have made sure that you have a copy of the key. For convience's sake, RavenDB offers the ability
to print the key (as well as it's QR code). The idea here is that you print this page, and then file it away in a locked 
cupboard somewhere. Even the most sophisticated of computer attakcs will have a hard time reaching to information stored on
paper, and that is a method that can easily be implemented. 

Of course, in many organizations there is already some policy around encryption keys usage, storage and backup. Sometimes it 
is with Hardware Security Modules, sometimes using services such as vault such as the Azure Vault, Keywhiz and HashiCorp Vault.
Regardless, you should have a copy of the encryption key.

> **What can an admin do with the encryption key?**
>
> Given the emphasis I just placed on the admin holding a copy of the encryption key, you might think that you'll be often
> using it. That cannot be further from the truth. There are _no_ cases where it is needed during normal operations. The
> encryption key is needed when you restore from a snapshot backup, if the machine is lost and you need to move the data
> to another machine (which must be provided with the key) and if you want to add a new node to the encrypted database
> group and want all the nodes to use the same key (which is desired, but not required).

Another requirement for encrypted databases is that the admin _has_ to select what nodes should be part of the encrypted database
group. Usually RavenDB will select these based on its own cognizance, but for encrypted databases, an admin needs to specify that
directly. This is to handle such cases where you have severs that might have different security zones in the same cluster. 

> **Storing the encryption keys**
> 
> Only the nodes actually particupating in the database group will have the encryption key for that database. At encrypted
> database creation time, RavenDB will contact each of the nodes that will host the database and give them the encryption
> key to use. This is done over an encrypted HTTPS request, of course.
> 
> For this reason, you need to select the nodes that will particpate manually and they must be up and available during the 
> database creation time so they can accept the new key.

Once the database is created, this is pretty much it, as far as deviations from the standard usage and configuration of databases
is concenred. 

### Full database encryption

Caesar, about 21 centuries ago, used a cipher to send messages securely, by shifting the letters of his messages by 3 characters.
When most of the population was illiterate, that was probably sufficent security. Today, the science of cryptography and 
cryptoanalysis is a _bit_ more complex.

The goal of encryption is to take an input and a key, and then generate a random looking pattern of bytes, with no
way to go back to the original input with having the key. That is only part of what a good encryption scheme must deal with 
today, though. Moderm cryptography needs to handle such things as timing (and other side channels) attack, forward secrecy and
many other details that are curcial for the security of the system but tend to be rather obtuse, onerous and obscure to those
who a



What is encrypted? Database files, scratch buffers, journals.

What isn't encrypted: identities, compare exchange values

Watch the logs file. 

#### Getting the data out

RavenDB ETL - HTTPS only, redacted?

SQL ETL - admin responsability

External replication 

#### The laptop scenario


#### Encrypting the server storage


### Key management

* Key backup
* Different keys for different servers


### Backing up encrypted databases

Snapshots (identities, compare exchange values, database record, not encrypted)
Backups - not encrypted at all
Incremental backups (never encrypted)


### Additional consdierations

* Memory locks
* Encryption of backups !!!